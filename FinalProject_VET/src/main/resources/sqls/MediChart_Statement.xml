<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.min.edu.model.mapper.MediChart_DaoImpl">

	<resultMap type="com.min.edu.vo.PetsInfo_VO" id="PetsVoMap">
		<result column="PET_SEQ" property="pet_seq"/>
		<result column="PET_OWNER" property="pet_owner"/>
		<result column="PET_NAME" property="pet_name"/>
		<result column="PET_BDAY" property="pet_bday"/>
		<result column="PET_SPECIES" property="pet_species"/>
		<result column="PET_GENDER" property="pet_gender"/>
		<result column="PET_NEUT" property="pet_neut"/>
		<result column="PET_REPORT" property="pet_report"/>
		
		<collection property="medichart_vo" resultMap="ChartVoMap"/>
	</resultMap>
	
	<resultMap type="com.min.edu.vo.MediChart_VO" id="ChartVoMap">
		<result column="MEDI_NUM" property="medi_num"/>
		<result column="MPET_SEQ" property="mpet_seq"/>
		<result column="MEDI_REGDATE" property="medi_regdate"/>
		<result column="MEDI_VISIT" property="medi_visit"/>
		<result column="MEDI_L" property="medi_l"/>
		<result column="MEDI_S" property="medi_s"/>
		<result column="MEDI_TITLE" property="medi_title"/>
		<result column="MEDI_CONTENT" property="medi_content"/>
		<result column="MEDI_ID" property="medi_id"/>
		<result column="MEDI_DELFLAG" property="medi_delflag"/>
		
		<collection property="fileboard_vo" resultMap="FileVoMap"/>
		<collection property="medicode_vo" resultMap="MCVoMap"/>
	</resultMap>

	<resultMap type="com.min.edu.vo.FileBoard_VO" id="FileVoMap">
		<result column="F_SEQ" property="f_seq"/>
		<result column="F_REF" property="f_ref"/>
		<result column="F_ORIGINNAME" property="f_originname"/>
		<result column="F_STOREDNAME" property="f_storedname"/>
		<result column="F_SIZE" property="f_size"/>
		<result column="F_DELFLAG" property="f_delflag"/>
	</resultMap>

	<resultMap type="com.min.edu.vo.MediCode_VO" id="MCVoMap">
		<result column="MEDI_CODE" property="medi_code"/>
		<result column="MEDI_NAME" property="medi_name"/>
		<result column="MEDI_TOP" property="medi_top"/>
	</resultMap>
	
	<!-- 일반사용자 아이디별 반려동물 수 체크 -->
	<select id="countPet" resultType="java.lang.Integer">
		SELECT COUNT(PET_SEQ) AS CNT
			FROM PETSINFO
			WHERE PET_OWNER =#{id}
	</select>
	
	<!-- 일반사용자 아이디별 반려동물명 리스트 조회 -->
	<select id="searchPet" resultType="com.min.edu.vo.PetsInfo_VO">
		SELECT PET_NAME 
			FROM PETSINFO
			WHERE PET_OWNER = #{id}
	</select>

	<!-- 새 반려동물 입력 -->
	<insert id="insertNewPet" parameterType="com.min.edu.vo.PetsInfo_VO">
	<selectKey keyProperty="pet_seq" resultType="java.lang.Integer" order="BEFORE">
		SELECT NVL(MAX(PET_SEQ),0)+1 AS PET_SEQ FROM PETSINFO
	</selectKey>
		INSERT INTO PETSINFO
			(PET_SEQ, PET_OWNER, PET_NAME, PET_BDAY, PET_SPECIES, PET_GENDER, PET_NEUT, PET_REPORT)
			VALUES(#{pet_seq},#{pet_owner}, #{pet_name}, #{pet_bday}, #{pet_species}, #{pet_gender}, #{pet_neut}, #{pet_report})
	</insert>

	<!-- 반려동물 삭제 -->
	<delete id="deletePet">
		DELETE FROM PETSINFO
			WHERE PET_SEQ=#{pet_seq}
	</delete>
	
	<!-- 새 진료기록 입력 -->
	<insert id="insertNewChart" parameterType="com.min.edu.vo.MediChart_VO">
	<selectKey keyProperty="medi_num" resultType="java.lang.String" order="BEFORE">
		SELECT 'M'|| (NVL(MAX(TO_NUMBER(SUBSTR(MEDI_NUM,2))),0)+1) FROM MEDICHART
	</selectKey>
		INSERT INTO MEDICHART
			(MEDI_NUM,
			MPET_SEQ, MEDI_REGDATE, MEDI_VISIT, 
			MEDI_L, MEDI_S, MEDI_TITLE, 
			MEDI_CONTENT, MEDI_ID, MEDI_DELFLAG)
			VALUES(#{medi_num}
					,#{mpet_seq}, (SYSDATE) ,#{medi_visit},
					#{medi_l}, #{medi_s}, #{medi_title}, 
					#{medi_content}, #{medi_id}, 'N')
	</insert>
	
	<!-- 일반사용자 ID별 진료기록 전체조회 -->
	<select id="selectAllChart" resultType="com.min.edu.vo.MediChart_VO">
		SELECT m.MEDI_NUM, m.MEDI_ID , m.MPET_SEQ , p.PET_NAME, m.MEDI_L , m2.MEDI_NAME , m.MEDI_S , m3.MEDI_NAME, m.MEDI_TITLE, m.MEDI_VISIT  
			FROM MEDICHART m 
			JOIN MEDICODE m2 ON m.MEDI_L = m2.MEDI_CODE 
			LEFT JOIN MEDICODE m3 ON m.MEDI_S = m3.MEDI_CODE 
			JOIN PETSINFO p ON m.MPET_SEQ = p.PET_SEQ 
			WHERE m.MEDI_ID =#{medi_id}
			AND m.MEDI_DELFLAG ='N'
			ORDER BY m.MEDI_VISIT DESC
	</select>
	
	<!-- 일반사용자 반려동물별 진료기록 조회 -->
	<select id="selectPetChart" resultType="com.min.edu.vo.MediChart_VO">
		SELECT m.MEDI_NUM, m.MEDI_ID , m.MPET_SEQ , p.PET_NAME, m.MEDI_L , m2.MEDI_NAME , m.MEDI_S , m3.MEDI_NAME, m.MEDI_TITLE, m.MEDI_VISIT  
			FROM MEDICHART m 
			JOIN MEDICODE m2 ON m.MEDI_L = m2.MEDI_CODE 
			LEFT JOIN MEDICODE m3 ON m.MEDI_S = m3.MEDI_CODE 
			JOIN PETSINFO p ON m.MPET_SEQ = p.PET_SEQ 
			WHERE m.MEDI_ID =#{medi_id}
			AND m.MEDI_DELFLAG ='N'
			AND p.PET_NAME =#{pet_name}
			ORDER BY MEDI_VISIT DESC
	</select>
	
	<!-- 일반사용자 진료코드 대분류별 진료기록 조회 -->
	<select id="selectLChart" resultType="com.min.edu.vo.MediChart_VO">
		SELECT m.MEDI_NUM, m.MEDI_ID , m.MPET_SEQ , p.PET_NAME, m.MEDI_L , m2.MEDI_NAME , m.MEDI_S , m3.MEDI_NAME, m.MEDI_TITLE, m.MEDI_VISIT 
			FROM MEDICHART m 
			JOIN MEDICODE m2 ON m.MEDI_L = m2.MEDI_CODE 
			LEFT JOIN MEDICODE m3 ON m.MEDI_S = m3.MEDI_CODE 
			JOIN PETSINFO p ON m.MPET_SEQ = p.PET_SEQ 
			WHERE m.MEDI_ID =#{medi_id}
			AND m.MEDI_DELFLAG ='N'
			AND m.MEDI_L = #{medi_l}
			ORDER BY MEDI_VISIT DESC
	</select>
	
	<!-- 일반사용자 진료코드 대분류,소분류별 진료기록 조회 -->
	<select id="selectSChart" resultType="com.min.edu.vo.MediChart_VO">
		SELECT m.MEDI_NUM, m.MEDI_ID , m.MPET_SEQ , p.PET_NAME, m.MEDI_L , m2.MEDI_NAME , m.MEDI_S , m3.MEDI_NAME, m.MEDI_VISIT  
			FROM MEDICHART m 
			JOIN MEDICODE m2 ON m.MEDI_L = m2.MEDI_CODE 
			LEFT JOIN MEDICODE m3 ON m.MEDI_S = m3.MEDI_CODE 
			JOIN PETSINFO p ON m.MPET_SEQ = p.PET_SEQ 
			WHERE MEDI_ID =#{medi_id}
			AND MEDI_DELFLAG ='N'
			AND m.MEDI_L = #{medi_l}
			AND m.MEDI_S =#{medi_s}
			ORDER BY MEDI_VISIT DESC
	</select>
	
	<!-- 일반사용자의 진료번호에 따른 진료기록 상세조회 -->
	<select id="selectOneChart" resultType="com.min.edu.vo.MediChart_VO">
		SELECT m.MEDI_NUM, m.MEDI_ID , m.MPET_SEQ , p.PET_NAME, m.MEDI_L , m2.MEDI_NAME , m.MEDI_S , m3.MEDI_NAME, DBMS_LOB.SUBSTR(m.MEDI_CONTENT,DBMS_LOB.GETLENGTH(m.MEDI_CONTENT)) , m.MEDI_VISIT  
			FROM MEDICHART m 
			JOIN MEDICODE m2 ON m.MEDI_L = m2.MEDI_CODE 
			LEFT JOIN MEDICODE m3 ON m.MEDI_S = m3.MEDI_CODE 
			JOIN PETSINFO p ON m.MPET_SEQ = p.PET_SEQ 
			WHERE MEDI_ID =#{medi_id}
			AND MEDI_DELFLAG ='N'
			AND MEDI_NUM =#{medi_num}
			ORDER BY MEDI_VISIT DESC
	</select>
	
	<!-- 진료기록 수정 -->
	<update id="modifyChart" parameterType="java.util.Map">
		UPDATE MEDICHART
			SET MEDI_CONTENT=#{medi_content}
			WHERE MEDI_NUM=#{medi_num}
	</update>
	
	<!-- 진료기록 삭제 -->
	<update id="deleteChart">
		UPDATE MEDICHART SET MEDI_DELFLAG='Y' 
			WHERE MEDI_NUM=#{medi_num}
	</update>
	
</mapper>
